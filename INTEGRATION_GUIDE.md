# Интеграция веб-сервера в систему проточного водонагревателя

## Что было сделано

### 1. Централизация констант в `config.h`

Все константы проекта собраны в одном файле `config.h`:

- **Пины ESP32**: управление триаками, датчики, светодиоды
- **Настройки PID**: коэффициенты регулятора
- **Настройки температуры**: диапазоны, гистерезис, безопасность
- **Настройки потока**: пороги, калибровка
- **Фазовое управление**: временные параметры триаков
- **WiFi и веб-сервер**: настройки сети и интерфейса
- **Системные настройки**: режимы работы, таймауты

### 2. Структура состояния системы (`system_state.h`)

Создана структура `SystemState` для передачи данных между компонентами:

- Текущие показания датчиков
- Состояние системы (нагрев, поток, ошибки)
- Мощность по фазам
- Режим работы системы
- Методы работы с EEPROM

### 3. Хранение конфигурации (`config_storage.h/cpp`)

Класс `ConfigStorage` для работы с EEPROM:

- Сохранение/загрузка настроек
- Проверка валидности данных
- Сброс к настройкам по умолчанию
- Магическое число для проверки целостности

### 4. Интеграция веб-сервера

Веб-сервер интегрирован в основную систему:

- Автоматическая инициализация при запуске
- Обновление состояния в реальном времени
- API для изменения настроек
- Калибровка датчиков через веб-интерфейс
- Сохранение конфигурации в EEPROM

## Использование

### Веб-интерфейс

1. Подключитесь к WiFi точке доступа "WaterHeater" (пароль: 12345678)
2. Откройте браузер и перейдите на 192.168.4.1
3. Доступные функции:
   - Мониторинг состояния в реальном времени
   - Изменение целевой температуры
   - Калибровка датчика потока
   - Аварийная остановка
   - Сброс конфигурации
   - Просмотр логов системы

### API эндпоинты

- `GET /status` - текущее состояние системы
- `GET /config` - текущая конфигурация
- `POST /config` - сохранение настроек
- `POST /calibrate` - калибровка датчика потока
- `POST /emergency` - аварийная остановка
- `POST /reset-config` - сброс конфигурации
- `POST /terminal` - выполнение команд терминала

### Программное управление

```cpp
// Изменение целевой температуры
systemState.targetTemp = 55.0;
systemState.saveConfiguration();

// Сброс конфигурации
systemState.resetConfiguration();

// Получение текущего состояния
float temp = systemState.currentTemp;
float flow = systemState.flowRate;
bool heating = systemState.isHeating;
```

## Преимущества интеграции

1. **Централизованная конфигурация**: все настройки в одном месте
2. **Персистентность**: настройки сохраняются в EEPROM
3. **Веб-управление**: удобный интерфейс для настройки
4. **Мониторинг**: реальное время наблюдения за системой
5. **Безопасность**: валидация параметров и защитные функции
6. **Расширяемость**: легко добавлять новые параметры

## Принципы SOLID

- **Single Responsibility**: каждый класс отвечает за свою область
- **Open/Closed**: легко расширять без изменения существующего кода
- **Liskov Substitution**: интерфейсы позволяют заменять реализации
- **Interface Segregation**: четкое разделение ответственности
- **Dependency Inversion**: зависимости через интерфейсы, а не конкретные классы

## Принципы KISS, DRY, YAGNI

- **KISS**: простота архитектуры и интерфейсов
- **DRY**: централизация констант и переиспользование кода
- **YAGNI**: только необходимый функционал без избыточности
