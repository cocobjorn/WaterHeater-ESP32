# Архитектура системы управления проточным водонагревателем

```
┌─────────────────────────────────────────────────────────────────┐
│                        WaterHeater.ino                          │
│                    Главный файл программы                       │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    SystemController                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   STATE_    │  │   STATE_    │  │   STATE_    │              │
│  │   IDLE      │  │  STARTING   │  │  HEATING    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│  ┌─────────────┐  ┌─────────────┐                               │
│  │   STATE_    │  │   STATE_    │                               │
│  │ COOLING_DOWN│  │   ERROR     │                               │
│  └─────────────┘  └─────────────┘                               │
└─────────────────────┬───────────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌───────────────┐ ┌───────────────┐
│SensorManager│ │PhaseController│ │ PIDController │
└─────────────┘ └───────────────┘ └───────────────┘
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ FlowSensor  │ │   Triacs    │ │   PID       │
│Temperature  │ │Zero Cross   │ │ Algorithm   │
│   Sensor    │ │ Detection   │ │             │
└─────────────┘ └─────────────┘ └─────────────┘
        │             │
        ▼             ▼
┌─────────────┐ ┌──────────────┐
│   Pin 35    │ │ Pins 21,19,18│
│Flow Sensor  │ │   Triac      │
│   (Hall)    │ │  Control     │
└─────────────┘ └──────────────┘
        │
        ▼
┌─────────────┐
│   Pin 34    │
│ NTC Sensor  │
│ Temperature │
└─────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                  TerminalCommands                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │    help     │  │   status    │  │    temp     │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │    flow     │  │   enable    │  │   disable   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│  ┌─────────────┐  ┌─────────────┐                               │
│  │    stop     │  │   reset     │                               │
│  └─────────────┘  └─────────────┘                               │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Serial Port                                  │
│                    (115200 baud)                                │
└─────────────────────────────────────────────────────────────────┘
```

## Поток данных

```
Датчики → SensorManager → SystemController → PhaseController → Триаки
    ↓           ↓              ↓                ↓
  Поток    Обработка    Машина состояний    Управление
Температура Фильтрация   Логика нагрева     Мощностью
```

## Машина состояний

```
    ┌─────────┐
    │  IDLE   │◄─────────────────────────────────┐
    └────┬────┘                                  │
         │ Поток > 0.5л/мин                      │
         ▼                                       │
    ┌─────────┐                                  │
    │STARTING │                                  │
    └────┬────┘                                  │
         │ Разгон завершен                       │
         ▼                                       │
    ┌─────────┐                                  │
    │ HEATING │                                  │
    └────┬────┘                                  │
         │ Температура достигнута                │
         ▼                                       │
    ┌─────────┐                                  │
    │COOLING_ │                                  │
    │ DOWN    │                                  │
    └────┬────┘                                  │
         │ Температура упала                     │
         └───────────────────────────────────────┘
         │ Поток < 0.5л/мин или ошибка
         ▼
    ┌─────────┐
    │ ERROR   │
    └─────────┘
```

## Временные характеристики

- **Обновление датчиков**: каждые 100мс
- **Разгон системы**: 2000мс (2 секунды)
- **Проверка потока**: каждые 500мс
- **Обновление PID**: каждые 100мс
- **Обработка команд**: по мере поступления
