# Руководство по настройке ПИД-регулятора

## Проблема

ПИД-регулятор работал нестабильно:

- Мощность скакала: 10.5% → 4.9% → 43.8% → 43.3%
- Резкие переходы между состояниями системы
- Нестабильный поток воды вызывал постоянные переключения

## Исправленная логика

### Правильная логика работы ПИД:

1. **100% мощность** когда температура далека от целевой (>5°C)
2. **80%+ мощность** при приближении к целевой (2-5°C)
3. **60% мощность** для поддержания температуры (<2°C)

### Ключевые принципы:

- **Нестабильный поток НЕ влияет** на работу ПИД
- **ПИД работает на максимум** до приближения к целевой температуре
- **Простая логика** без сложных переходов

## Внесенные изменения

### 1. Оптимизация параметров ПИД

**Было:**

- Kp = 2.0 (слишком агрессивно)
- Ki = 0.1 (вызывало перерегулирование)
- Kd = 0.5 (усиливало колебания)

**Стало:**

- Kp = 0.8 (более мягкий отклик)
- Ki = 0.05 (меньше интегрального накопления)
- Kd = 0.2 (меньше дифференциального воздействия)

### 2. Упрощенная логика состояний

```cpp
// STATE_HEATING - активный нагрев
if (temperatureError > 5.0) {
    finalPower = 100.0;  // Работаем на максимум
} else if (temperatureError > 2.0) {
    finalPower = max(pidOutput, 80.0f);  // Не менее 80%
} else {
    transitionToState(STATE_COOLING_DOWN);  // Переходим к поддержанию
}

// STATE_COOLING_DOWN - поддержание температуры
finalPower = min(pidOutput, 60.0f);  // Максимум 60%
```

### 3. Стабилизация потока

- **Гистерезис потока** - минимальный интервал 200мс между изменениями
- **Простой разгон** до 100% без сложных переходов
- **Сброс ПИД** при переходе к активному нагреву

### 4. Улучшенная отладка

```
ПИД: Ошибка=21.40°C, ПИД-выход=43.8%, Логика=100% (далеко)
ПИД: Ошибка=3.20°C, ПИД-выход=25.6%, Логика=80%+ (приближение)
ПИД: Ошибка=1.50°C, ПИД-выход=45.2%, Логика=60% (поддержание)
```

## Ожидаемые результаты

1. **Стабильная мощность** - 100% до приближения к целевой температуре
2. **Независимость от потока** - ПИД работает по температуре, а не по потоку
3. **Простая логика** - понятные пороги переключения состояний
4. **Быстрый нагрев** - максимальная мощность до достижения температуры

## Пороги переключения

- **>5°C от цели** → 100% мощность (активный нагрев)
- **2-5°C от цели** → 80%+ мощность (приближение)
- **<2°C от цели** → 60% мощность (поддержание)
- **>3°C от цели** → возврат к активному нагреву

## Мониторинг

Следите за логами:

- Логика принятия решений ("100% (далеко)", "80%+ (приближение)", "60% (поддержание)")
- Стабильность мощности на каждом этапе
- Время достижения целевой температуры
- Частота переключений между состояниями

## Исправления компиляции

Исправлены ошибки типов:

- `max(pidOutput, 80.0)` → `max(pidOutput, 80.0f)`
- `min(pidOutput, 60.0)` → `min(pidOutput, 60.0f)`

Это обеспечивает совместимость типов `float` в Arduino/ESP32.
