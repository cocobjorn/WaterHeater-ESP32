# Система управления проточным водонагревателем

## Описание

Полная система управления проточным водонагревателем на ESP32 с трехфазным управлением триаками, PID регулированием температуры и автоматическим управлением по потоку воды.

## Основные функции

### ✅ Реализованные требования:

1. **Автоматическое управление по потоку**
   - Включение нагрева при потоке >0.5л/мин
   - Мгновенное выключение при прекращении потока
   - Датчик потока на эффекте Холла (600 имп/литр)

2. **Плавный разгон**
   - Разгон до полной мощности за 2 секунды
   - Линейное увеличение мощности без скачков
   - Плавное снижение мощности при достижении температуры

3. **PID регулирование температуры**
   - Диапазон температуры: 40-65°C
   - Настраиваемые PID параметры
   - Плавное поддержание заданной температуры

4. **Режим покоя**
   - Минимальное потребление ресурсов в режиме ожидания
   - Только мониторинг датчиков потока и температуры
   - Быстрое пробуждение при появлении потока

5. **Защитные функции**
   - Аварийная остановка при перегреве
   - Проверка корректности показаний датчиков
   - Защита от некорректных команд

## Архитектура системы

### Основные компоненты:

1. **SystemController** - Главный контроллер системы
   - Управление состояниями (покой, запуск, нагрев, поддержание)
   - Координация работы всех компонентов
   - Защитные функции

2. **SensorManager** - Управление датчиками
   - FlowSensor - датчик потока воды
   - TemperatureSensor - NTC датчик температуры
   - Фильтрация и обработка данных

3. **PhaseController** - Управление триаками
   - Трехфазное управление
   - Детектор пересечения нуля
   - Плавное регулирование мощности

4. **PIDController** - PID регулятор
   - Пропорционально-интегрально-дифференциальное регулирование
   - Настраиваемые параметры
   - Ограничения выходного сигнала

5. **TerminalCommands** - Терминальный интерфейс
   - Команды управления системой
   - Мониторинг состояния
   - Настройка параметров

## Состояния системы

1. **STATE_IDLE** - Режим покоя
   - Только мониторинг датчиков
   - Нагрев отключен
   - Минимальное потребление ресурсов

2. **STATE_STARTING** - Плавный запуск
   - Разгон до полной мощности за 2 секунды
   - Линейное увеличение мощности
   - Переход к активному нагреву

3. **STATE_HEATING** - Активный нагрев
   - PID регулирование температуры
   - Полная мощность до достижения цели
   - Переход к поддержанию при достижении температуры

4. **STATE_COOLING_DOWN** - Поддержание температуры
   - Ограниченная мощность (до 50%)
   - Плавное поддержание заданной температуры
   - Возврат к активному нагреву при падении температуры

5. **STATE_ERROR** - Аварийная остановка
   - Полное отключение нагрева
   - Сохранение состояния ошибки
   - Требует сброса системы

## Терминальные команды

- `help` - Справка по командам
- `status` - Статус системы
- `temp` - Текущая температура
- `flow` - Текущий поток воды
- `enable` - Включить нагрев
- `disable` - Выключить нагрев
- `stop` - Аварийная остановка
- `reset` - Сброс системы
- `temp <значение>` - Установить температуру (40-65°C)
- `flow <значение>` - Установить минимальный поток (л/мин)

## Настройки по умолчанию

- Минимальный поток: 0.5 л/мин
- Целевая температура: 50°C
- Диапазон температуры: 40-65°C
- Время разгона: 2000 мс (2 секунды)
- PID параметры: Kp=2.0, Ki=0.1, Kd=0.5

## Пины ESP32

- **Триаки**: 21, 19, 18 (L1, L2, L3)
- **Детектор нуля**: 15
- **NTC датчик**: 34
- **Датчик потока**: 35
- **LED статуса**: 2

## Принципы разработки

### SOLID принципы:
- **S** - Single Responsibility: каждый класс имеет одну ответственность
- **O** - Open/Closed: система открыта для расширения, закрыта для модификации
- **L** - Liskov Substitution: компоненты взаимозаменяемы
- **I** - Interface Segregation: четкие интерфейсы
- **D** - Dependency Inversion: зависимость от абстракций

### Другие принципы:
- **KISS** - Keep It Simple, Stupid
- **DRY** - Don't Repeat Yourself
- **YAGNI** - You Aren't Gonna Need It
- **BDUF** - Big Design Up Front

## Безопасность

- Проверка корректности показаний датчиков
- Аварийная остановка при критических условиях
- Ограничения по температуре и мощности
- Защита от некорректных команд пользователя
- Валидация входных параметров

## Производительность

- Оптимизированные алгоритмы чтения датчиков
- Эффективное использование прерываний
- Минимальные задержки в критических участках
- Режим покоя для экономии ресурсов
- Фильтрация данных для стабильности