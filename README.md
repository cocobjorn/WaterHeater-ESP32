# Проточный водонагреватель 9кВт на ESP32

Система управления 3-фазным проточным водонагревателем мощностью 9кВт (3×3кВт) с использованием ESP32, симисторов BTA41-600B и платы расширения HW-777.

## Особенности

- **3-фазное управление**: Независимое управление тремя фазами по 3кВт каждая
- **Датчики**: NTC термистор для температуры, датчик протока на эффекте Холла
- **Безопасность**: Термопредохранитель, 3-фазное реле защиты, UZO и автоматы
- **Веб-интерфейс**: Настройка и мониторинг через WiFi
- **Алгоритм Брезенхэма**: Плавное управление мощностью нагрева
- **Защита**: Аварийное отключение при превышении температуры или отсутствии протока

## Схема подключения

### ESP32 + HW-777

- **NTC датчик**: Пин 34 (ADC)
- **Датчик протока**: Пин 35 (прерывание)
- **Симисторы**: Пины 21, 19, 18 (ШИМ)
- **Реле HW-777**: Пины 2, 4, 5 (L1, L2, L3)
- **Термопредохранитель**: Пин 16 (цифровой вход)

### Внешние компоненты

- **Симисторы**: BTA41-600B с оптопарами MOC3041
- **Нагреватели**: 3×3кВт ТЭНы
- **Защита**: 3-фазное реле 25А, термопредохранитель

## Настройка

1. **Установка PlatformIO**:

   ```bash
   pip install platformio
   ```

2. **Загрузка проекта**:

   ```bash
   git clone <repository>
   cd water-heater-esp32
   ```

3. **Компиляция и загрузка**:

   ```bash
   pio run -t upload
   ```

4. **Мониторинг**:
   ```bash
   pio device monitor
   ```

## Конфигурация

Основные настройки в файле `config.h`:

```cpp
// Температура
#define TARGET_TEMP_DEFAULT 50.0    // Целевая температура
#define TARGET_TEMP_MIN 40.0        // Минимальная температура
#define TARGET_TEMP_MAX 60.0        // Максимальная температура

// Проток
#define FLOW_THRESHOLD_MIN 0.5      // Минимальный проток для включения
#define FLOW_CALIBRATION_FACTOR 7.5 // Калибровочный коэффициент

// WiFi
#define WIFI_SSID "WaterHeater_Config"
#define WIFI_PASSWORD "heater123456"
```

## Веб-интерфейс

После запуска система создает WiFi точку доступа:

- **SSID**: WaterHeater_Config
- **Пароль**: heater123456
- **IP**: 192.168.4.1

### Функции веб-интерфейса:

- Мониторинг температуры и протока в реальном времени
- Настройка целевой температуры (40-60°C)
- Калибровка датчика протока
- Аварийная остановка системы
- Просмотр логов работы

## Алгоритм работы

1. **Инициализация**: Проверка всех датчиков и систем безопасности
2. **Мониторинг**: Постоянное чтение температуры и протока
3. **Управление нагревом**:
   - Включение при протоке > 0.5 л/мин
   - Выключение при достижении целевой температуры
   - Плавное изменение мощности по алгоритму Брезенхэма
4. **Безопасность**:
   - Отключение при срабатывании термопредохранителя
   - Таймаут при отсутствии протока (5 минут)
   - Максимальная температура 80°C

## Безопасность

### Многоуровневая защита:

1. **Термопредохранитель**: Физическое отключение питания
2. **Программная защита**: Контроль температуры и протока
3. **Реле защиты**: 3-фазное реле 25А на фазу
4. **Внешняя защита**: UZO и автоматы

### Аварийные ситуации:

- Превышение максимальной температуры (80°C)
- Отсутствие протока более 5 минут
- Срабатывание термопредохранителя
- Ошибка датчика температуры

## Технические характеристики

- **Мощность**: 9кВт (3×3кВт)
- **Напряжение**: 3×380В
- **Ток**: 3×13.6А
- **Температура**: 40-60°C (настраивается)
- **Проток**: 0.5-1.0 л/мин (настраивается)
- **Управление**: ШИМ 1кГц, 8-бит разрешение

## Структура проекта

```
├── WaterHeater.ino          # Основной файл
├── config.h                 # Конфигурация
├── sensors.h/cpp           # Работа с датчиками
├── triac_control.h/cpp     # Управление симисторами
├── web_server.h/cpp        # Веб-интерфейс
├── safety.h/cpp            # Система безопасности
├── utils.h/cpp             # Вспомогательные функции
├── platformio.ini          # Настройки PlatformIO
└── README.md               # Документация
```

## Принципы разработки

- **KISS**: Простота и понятность кода
- **DRY**: Избежание дублирования
- **SOLID**: Принципы объектно-ориентированного программирования
- **Безопасность**: Многоуровневая защита системы
- **Надежность**: Обработка ошибок и аварийных ситуаций

## Лицензия

Проект создан для образовательных целей. При использовании в коммерческих целях соблюдайте все требования безопасности и сертификации.
