# Руководство по диагностике датчика потока

## Проблемы, которые были исправлены

### 1. Неправильный расчет скорости потока

**Проблема**: В методе `update()` использовалась неправильная логика расчета - `lastFlowTime` не обновлялось, что приводило к неправильным расчетам.

**Решение**:

- Добавлен правильный сброс счетчика импульсов после расчета
- Исправлена логика обновления времени измерения
- Добавлена проверка минимального времени измерения (1 секунда)

### 2. Отсутствие сброса счетчика импульсов

**Проблема**: Счетчик импульсов никогда не сбрасывался, что могло привести к накоплению ошибок.

**Решение**:

- Добавлен автоматический сброс счетчика после каждого расчета
- Сброс происходит при таймауте потока

### 3. Неэффективная фильтрация

**Проблема**: Отсутствовала фильтрация показаний потока.

**Решение**:

- Добавлена защита от дребезга в ISR
- Улучшена логика определения потока
- Добавлена проверка минимального интервала между импульсами

## Новые диагностические возможности

### Команды терминала

- `flowdiag` или `fd` - Полная диагностика датчика потока
- `testflow` - Интерактивный тест датчика потока (30 секунд)

### Автоматическая диагностика

- Расширенное логирование каждые 3 секунды
- Показ состояния пина датчика
- Мониторинг времени последнего импульса
- Проверка работоспособности датчика

## Как использовать диагностику

### 1. Через терминал

```
> flowdiag
```

Покажет полную информацию о состоянии датчика потока.

### 2. Интерактивный тест

```
> testflow
```

Запустит 30-секундный тест, во время которого можно крутить турбинку датчика.

### 3. Автоматический мониторинг

Система автоматически выводит диагностическую информацию каждые 3 секунды в обычном режиме работы.

## Возможные проблемы и решения

### Датчик не реагирует на поток

1. Проверьте подключение к пину 35
2. Убедитесь, что датчик подключен правильно (GND, VCC, Signal)
3. Проверьте состояние пина командой `flowdiag`

### Ложные срабатывания

1. Проверьте качество подключения
2. Убедитесь в отсутствии помех от других устройств
3. Проверьте настройки защиты от дребезга

### Неточные показания потока

1. Проверьте коэффициент калибровки (по умолчанию 400 имп/л)
2. Выполните калибровку с известным объемом воды
3. Проверьте минимальный порог потока (по умолчанию 0.1 л/мин)

## Технические детали

### Настройки датчика потока

- Пин: 35 (FLOW_SENSOR_PIN)
- Коэффициент калибровки: 400 импульсов/литр
- Минимальный порог: 0.1 л/мин
- Таймаут потока: 1000 мс
- Минимальный интервал между импульсами: 10 мс

### Логика работы

1. ISR считает импульсы с защитой от дребезга
2. Каждые 100мс обновляется расчет скорости потока
3. При таймауте поток сбрасывается в 0
4. Система определяет наличие потока по превышению минимального порога
